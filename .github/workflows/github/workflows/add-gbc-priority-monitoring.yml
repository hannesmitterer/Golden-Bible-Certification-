name: Activate GBC priority monitoring

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch name to create'
        required: false
        default: 'add/gbc-priority-monitoring'
      commit_message:
        description: 'Commit message'
        required: false
        default: 'Activate GBC priority monitoring — add investment_config.yaml'

jobs:
  create-pr:
    name: Create branch, commit investment_config.yaml and open PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Create investment_config.yaml
        run: |
          cat > investment_config.yaml <<'YAML'
          # GBC Priority Monitoring configuration - generated by Copilot on user command
          investment_wallets:
            platform_funding:
              address: "0x6c10692145718353070cc6cb5c21adf2073ffa1fD"
              chain: "polygon"
              chain_id: 137
              asset: "USDC"
              decimals: 6
              threshold_security_usd: 5000
              notes: "Active monitoring for platform funding (GBC priority)."
            governance_audit:
              address: "0x6c10692145718353070cc6cb5c21adf2073ffa1fD"
              chain: "polygon"
              chain_id: 137
              asset: "USDC"
              decimals: 6
              threshold_security_usd: 5000
              notes: "Active monitoring for governance audit flows (security threshold at 5000 USD)."
            digital_bonds_offer:
              address: "0x6c10692145718353070cc6cb5c21adf2073ffa1fD"
              chain: "polygon"
              chain_id: 137
              asset: "USDC"
              decimals: 6
              contract_address: ""        # Bond contract missing — monitoring in STANDBY
              notes: "Bond automation is standby until contract_address is provided."

          api:
            metrics_endpoint: "/api/v1/metrics"
            host: "http://127.0.0.1:5000"

          monitoring:
            provider: "alchemy"
            webhook:
              enabled: true
              events:
                - "incoming_transfer"
                - "transfer"
                - "deposit"
              filters:
                token: "USDC"
                chain_id: 137
                address: "0x6c10692145718353070cc6cb5c21adf2073ffa1fD"
              retry_policy:
                max_retries: 5
                backoff: "exponential"
            on_thresholds:
              governance_audit_security:
                enabled: true
                threshold_usd: 5000
                actions:
                  - "notify_ops"
                  - "trigger_social_broadcast"

          alerts:
            delivery:
              methods:
                - "telegram"
                - "email"
                - "webhook"
            telegram:
              enabled: true
              chat_id: "" # set in environment

          automation:
            on_deposit:
              - action: "notify_ops"
                targets:
                  - "ops@seedbringer.org"
              - action: "record_event_store"
            on_large_deposit:
              threshold_usd: 5000
              actions:
                - "trigger_broadcast"
                - "create_github_issue"

          bond_monitoring:
            status: "STANDBY"
            reason: "Missing deployed contract_address for KarmaBond.sol. Full Bond automation pending address receipt."

          notes:
            - "This file activates selective GBC monitoring while bond contract is not yet deployed."
            - "No secrets present. Store provider API keys (ALCHEMY_API_KEY, NEXUS_TOKEN) in environment or secret manager."
            - "After merge: restart backend and verify /api/v1/metrics exposes investment.offer_details and monitoring subscriptions."
          YAML

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create branch and commit
        run: |
          BRANCH="${{ github.event.inputs.branch }}"
          git checkout -b "$BRANCH"
          git add investment_config.yaml
          git commit -m "${{ github.event.inputs.commit_message }}"
          git push --set-upstream origin "$BRANCH"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Activate GBC priority monitoring — add investment_config.yaml"
          title: "Activate GBC priority monitoring — investment config"
          body: |
            # PR: Activate GBC priority monitoring — add investment_config.yaml

            Summary
            -------
            Attiva il monitoraggio prioritario GBC (Governance & Development) usando il Wallet Unico su Polygon:
            - Wallet: 0x6c10692145718353070cc6cb5c21adf2073ffa1fD
            - Network: Polygon Mainnet (chain_id: 137)
            - Asset: USDC (decimals: 6)
            - Bond monitoring: STANDBY (contract_address mancante)

            Files added/updated
            -------------------
            - investment_config.yaml — configura monitoraggio selettivo per platform_funding e governance_audit; digital_bonds_offer in STANDBY.

            Purpose
            -------
            Abilitare i flussi operativi necessari:
            - webhook on-chain per incoming_transfer (USDC) verso il wallet unico
            - alert realtime per depositi > 5,000 USD (Telegram/email/webhook)
            - telemetria periodica su /api/v1/metrics
            - azioni automatizzate: broadcast social + creazione issue su depositi rilevanti

            Checklist before merging
            ------------------------
            - [ ] Verificare che `chain` e `chain_id` siano corretti (Polygon Mainnet).
            - [ ] Impostare CHAT_ID Telegram e segreti provider (ALCHEMY_API_KEY, NEXUS_TOKEN, GH_TOKEN).
            - [ ] Se disponibile, aggiungere `contract_address` per KarmaBond.sol per abilitare bond automation.
            - [ ] Controllare endpoint callback (Make/Zapier o handler pubblico) per latenza.

            Verification steps after merge
            ------------------------------
            1. Riavvia il backend / container.
            2. Verifica endpoint metrics:
               curl -s http://127.0.0.1:5000/api/v1/metrics | jq '.investment.offer_details'
            3. Esegui smoke test (testnet o piccolo trasferimento Mainnet) e verifica che:
               - webhook venga ricevuto,
               - Telegram/email notifiche siano inviate,
               - actions (broadcast/issue) vengano create come previsto.

            Notes
            -----
            Questa PR attiva il monitoring prioritario GBC e lascia la logica Bond in stand-by fino a ricezione del contract_address.
          base: main
          labels: monitoring,GBC
